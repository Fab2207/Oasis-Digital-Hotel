<!DOCTYPE html>
<html class="dark" lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/common :: head"></head>
  <body
    class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 overflow-hidden"
  >
    <div class="flex h-screen w-full overflow-hidden">
      <!-- SideNavBar -->
      <aside th:replace="fragments/common :: sidebar"></aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <!-- Background Elements -->
        <div
          class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none"
        >
          <div
            class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] rounded-full bg-primary/5 blur-[100px]"
          ></div>
          <div
            class="absolute bottom-[-10%] left-[-5%] w-[500px] h-[500px] rounded-full bg-accent/5 blur-[100px]"
          ></div>
        </div>

        <!-- Top Header -->
        <header th:replace="fragments/common :: navbar"></header>

        <main class="flex-1 overflow-y-auto p-8 scroll-smooth">
          <div class="max-w-7xl mx-auto flex flex-col gap-8">
            <!-- Messages -->
            <div
              th:if="${successMessage}"
              class="p-4 rounded-xl bg-green-500/10 border border-green-500/20 text-green-400 flex items-center gap-3 backdrop-blur-sm"
            >
              <span class="material-symbols-outlined">check_circle</span>
              <span th:text="${successMessage}"></span>
            </div>
            <div
              th:if="${errorMessage}"
              class="p-4 rounded-xl bg-red-500/10 border border-red-500/20 text-red-400 flex items-center gap-3 backdrop-blur-sm"
            >
              <span class="material-symbols-outlined">error</span>
              <span th:text="${errorMessage}"></span>
            </div>

            <!-- PageHeading -->
            <div class="flex flex-col gap-2">
              <h1
                class="text-white text-4xl font-black tracking-tight"
                th:text="'Bienvenido, ' + (${cliente.nombres} ?: 'Usuario')"
              >
                Bienvenido, Alejandro
              </h1>
              <p class="text-white/60 text-lg font-medium">
                Aquí tienes un resumen de tu actividad reciente.
              </p>
            </div>

            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
              <div
                class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl flex flex-col gap-2 relative overflow-hidden group"
              >
                <div
                  class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
                >
                  <span class="material-symbols-outlined text-6xl text-white"
                    >calendar_month</span
                  >
                </div>
                <p
                  class="text-white/60 text-sm font-bold uppercase tracking-wider"
                >
                  Próximas Reservas
                </p>
                <p
                  class="text-white text-4xl font-black tracking-tight"
                  th:text="${reservasActivas}"
                >
                  2
                </p>
              </div>
              <div
                class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl flex flex-col gap-2 relative overflow-hidden group"
              >
                <div
                  class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
                >
                  <span class="material-symbols-outlined text-6xl text-white"
                    >history</span
                  >
                </div>
                <p
                  class="text-white/60 text-sm font-bold uppercase tracking-wider"
                >
                  Estancias Totales
                </p>
                <p
                  class="text-white text-4xl font-black tracking-tight"
                  th:text="${totalReservas}"
                >
                  15
                </p>
              </div>
              <div
                class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl flex flex-col gap-2 relative overflow-hidden group"
              >
                <div
                  class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
                >
                  <span class="material-symbols-outlined text-6xl text-accent"
                    >loyalty</span
                  >
                </div>
                <p
                  class="text-white/60 text-sm font-bold uppercase tracking-wider"
                >
                  Puntos de Lealtad
                </p>
                <p class="text-accent text-4xl font-black tracking-tight">
                  4,500
                </p>
              </div>
              <div
                class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl flex flex-col gap-2 relative overflow-hidden group"
              >
                <div
                  class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"
                >
                  <span class="material-symbols-outlined text-6xl text-white"
                    >check_circle</span
                  >
                </div>
                <p
                  class="text-white/60 text-sm font-bold uppercase tracking-wider"
                >
                  Reservas Finalizadas
                </p>
                <p
                  class="text-white text-4xl font-black tracking-tight"
                  th:text="${reservasFinalizadas}"
                >
                  8
                </p>
              </div>
            </div>

            <!-- Section Próximas Reservas -->
            <div class="flex flex-col gap-6">
              <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                <span class="p-2 rounded-lg bg-primary/10 text-primary">
                  <span class="material-symbols-outlined">event_upcoming</span>
                </span>
                Próximas Reservas
              </h2>

              <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div
                  th:each="reserva : ${reservas}"
                  th:if="${reserva.estadoReserva == 'ACTIVA' || reserva.estadoReserva == 'PENDIENTE'}"
                  class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl flex flex-col gap-4 hover:border-white/20 transition-all duration-300 group"
                >
                  <div class="flex justify-between items-start">
                    <div class="flex flex-col gap-1">
                      <h3
                        class="text-xl font-bold text-white group-hover:text-primary transition-colors"
                        th:text="${reserva.habitacion.numero + ' - ' + reserva.habitacion.tipo}"
                      >
                        Habitación 101 - Suite
                      </h3>
                      <p class="text-sm text-white/60">Oasis Digital Hotel</p>
                    </div>
                    <span
                      class="px-3 py-1 rounded-full text-xs font-bold border"
                      th:classappend="${reserva.estadoReserva == 'ACTIVA' ? 'bg-green-500/10 text-green-400 border-green-500/20' : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'}"
                      th:text="${reserva.estadoReserva}"
                    >
                      Confirmada
                    </span>
                  </div>

                  <div
                    class="grid grid-cols-2 gap-4 py-4 border-y border-white/5"
                  >
                    <div class="flex flex-col gap-1">
                      <p
                        class="text-xs font-bold text-white/40 uppercase tracking-wider"
                      >
                        Check-in
                      </p>
                      <div class="flex items-center gap-2 text-white">
                        <span class="material-symbols-outlined text-primary"
                          >login</span
                        >
                        <span
                          class="font-bold"
                          th:text="${#temporals.format(reserva.fechaInicio, 'dd MMM, yyyy')}"
                          >15 Dic, 2024</span
                        >
                      </div>
                    </div>
                    <div class="flex flex-col gap-1 text-right">
                      <p
                        class="text-xs font-bold text-white/40 uppercase tracking-wider"
                      >
                        Check-out
                      </p>
                      <div
                        class="flex items-center gap-2 text-white justify-end"
                      >
                        <span
                          class="font-bold"
                          th:text="${#temporals.format(reserva.fechaFin, 'dd MMM, yyyy')}"
                          >22 Dic, 2024</span
                        >
                        <span class="material-symbols-outlined text-primary"
                          >logout</span
                        >
                      </div>
                    </div>
                  </div>

                  <div class="flex items-center justify-between">
                    <p
                      class="text-xs text-white/40 font-mono"
                      th:text="'REF: #' + ${reserva.id}"
                    >
                      REF: #A8B2C5D6
                    </p>
                    <div class="flex items-center gap-2">
                      <div
                        th:if="${reserva.estadoReserva == 'PENDIENTE'}"
                        class="flex gap-2"
                      >
                        <a
                          th:href="@{/reservas/{id}/pago(id=${reserva.id})}"
                          class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg text-sm font-bold transition-colors shadow-lg shadow-green-500/20"
                        >
                          Pagar
                        </a>
                        <form
                          th:action="@{/reservas/cancelar/{id}(id=${reserva.id})}"
                          method="post"
                          onsubmit="return confirm('¿Está seguro de rechazar esta reserva?')"
                        >
                          <button
                            type="submit"
                            class="px-4 py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 rounded-lg text-sm font-bold transition-colors"
                          >
                            Rechazar
                          </button>
                        </form>
                      </div>
                      <button
                        th:unless="${reserva.estadoReserva == 'PENDIENTE'}"
                        th:onclick="'openDetailsModal(' + ${reserva.id} + ')'"
                        class="px-4 py-2 rounded-lg bg-white/5 hover:bg-white/10 text-white text-sm font-bold transition-colors"
                      >
                        Ver Detalles
                      </button>
                    </div>
                  </div>
                </div>

                <div
                  th:if="${#lists.isEmpty(reservas) || reservasActivas == 0}"
                  class="col-span-2 flex flex-col items-center justify-center py-12 text-white/30 border-2 border-dashed border-white/10 rounded-2xl bg-white/5"
                >
                  <span
                    class="material-symbols-outlined text-5xl mb-3 opacity-50"
                    >event_busy</span
                  >
                  <p class="text-lg font-medium">No hay reservas próximas</p>
                </div>
              </div>
            </div>

            <!-- Section Historial de Reservas -->
            <div class="flex flex-col gap-6">
              <h2 class="text-2xl font-bold text-white flex items-center gap-2">
                <span class="p-2 rounded-lg bg-white/5 text-white">
                  <span class="material-symbols-outlined">history</span>
                </span>
                Historial de Reservas
              </h2>

              <div
                class="glass-panel rounded-2xl overflow-hidden border border-white/10 shadow-xl"
              >
                <div class="overflow-x-auto">
                  <table class="w-full text-left text-sm">
                    <thead
                      class="bg-white/5 text-xs uppercase text-white/40 font-medium tracking-wider"
                    >
                      <tr>
                        <th class="px-6 py-4">Habitación</th>
                        <th class="px-6 py-4">Fechas</th>
                        <th class="px-6 py-4">Costo Total</th>
                        <th class="px-6 py-4">Estado</th>
                        <th class="px-6 py-4 text-right">Acciones</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                      <tr
                        th:each="reserva : ${reservas}"
                        class="hover:bg-white/5 transition-colors"
                      >
                        <td class="px-6 py-4 font-bold text-white">
                          <div class="flex items-center gap-3">
                            <div
                              class="size-8 rounded-lg bg-white/5 flex items-center justify-center text-white/40"
                            >
                              <span class="material-symbols-outlined text-lg"
                                >bed</span
                              >
                            </div>
                            <span
                              th:text="${reserva.habitacion.numero + ' - ' + reserva.habitacion.tipo}"
                              >101 - Suite</span
                            >
                          </div>
                        </td>
                        <td
                          class="px-6 py-4 text-white/60"
                          th:text="${#temporals.format(reserva.fechaInicio, 'dd MMM') + ' - ' + #temporals.format(reserva.fechaFin, 'dd MMM, yyyy')}"
                        >
                          01 Ago - 07 Ago, 2024
                        </td>
                        <td
                          class="px-6 py-4 font-mono font-bold text-white"
                          th:text="'S/. ' + ${reserva.totalPagar}"
                        >
                          S/. 3,250.00
                        </td>
                        <td class="px-6 py-4">
                          <span
                            class="px-2.5 py-1 rounded-full text-xs font-bold border"
                            th:classappend="${reserva.estadoReserva == 'FINALIZADA' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : (reserva.estadoReserva == 'CANCELADA' ? 'bg-red-500/10 text-red-400 border-red-500/20' : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20')}"
                            th:text="${reserva.estadoReserva}"
                          >
                            FINALIZADA
                          </span>
                        </td>
                        <td class="px-6 py-4 text-right">
                          <button
                            th:if="${reserva.estadoReserva == 'FINALIZADA' || reserva.estadoReserva == 'CANCELADA'}"
                            class="text-accent hover:text-accent/80 font-bold text-xs uppercase tracking-wider transition-colors mr-3"
                            th:onclick="'openReviewModal(' + ${reserva.id} + ')'"
                          >
                            Escribir Reseña
                          </button>
                          <button
                            class="text-white/40 hover:text-white font-bold text-xs uppercase tracking-wider transition-colors"
                            th:onclick="'openDetailsModal(' + ${reserva.id} + ')'"
                          >
                            Ver Detalles
                          </button>
                        </td>
                      </tr>
                      <tr th:if="${#lists.isEmpty(reservas)}">
                        <td
                          colspan="5"
                          class="px-6 py-12 text-center text-white/30 flex flex-col items-center gap-2"
                        >
                          <span
                            class="material-symbols-outlined text-4xl opacity-50"
                            >history_toggle_off</span
                          >
                          No tienes reservas registradas
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    <!-- Modals -->
    <!-- Details Modal -->
    <div id="detailsModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeDetailsModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-[#1e293b] border border-white/10 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <div class="px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left w-full">
                                <h3 class="text-xl font-bold leading-6 text-white mb-4" id="modal-title">Detalles de la Reserva</h3>
                                <div id="modalContent" class="mt-2 text-gray-300 space-y-3">
                                    <!-- Content injected via JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-[#0f172a] px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-white/5">
                        <button type="button" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white/5 px-3 py-2 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-white/10 hover:bg-white/10 sm:mt-0 sm:w-auto transition-colors" onclick="closeDetailsModal()">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="fixed inset-0 z-50 hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-black/80 backdrop-blur-sm transition-opacity" onclick="closeReviewModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-[#1e293b] border border-white/10 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                    <form action="/resenas/crear" method="post" class="w-full">
                        <div class="px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                            <h3 class="text-xl font-bold leading-6 text-white mb-4">Escribir Reseña</h3>
                            <input type="hidden" id="reviewReservaId" name="reservaId">
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">Calificación</label>
                                    <div class="flex gap-2 text-yellow-400 text-2xl">
                                        <button type="button" onclick="setRating(1)" class="hover:scale-110 transition-transform"><span class="material-symbols-outlined star-rating" data-value="1">star_border</span></button>
                                        <button type="button" onclick="setRating(2)" class="hover:scale-110 transition-transform"><span class="material-symbols-outlined star-rating" data-value="2">star_border</span></button>
                                        <button type="button" onclick="setRating(3)" class="hover:scale-110 transition-transform"><span class="material-symbols-outlined star-rating" data-value="3">star_border</span></button>
                                        <button type="button" onclick="setRating(4)" class="hover:scale-110 transition-transform"><span class="material-symbols-outlined star-rating" data-value="4">star_border</span></button>
                                        <button type="button" onclick="setRating(5)" class="hover:scale-110 transition-transform"><span class="material-symbols-outlined star-rating" data-value="5">star_border</span></button>
                                    </div>
                                    <input type="hidden" name="calificacion" id="ratingInput" value="5" required>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-400 mb-1">Comentario</label>
                                    <textarea name="comentario" rows="4" class="w-full rounded-lg bg-[#0f172a] border border-gray-700 text-white p-3 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all" placeholder="Cuéntanos tu experiencia..." required></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="bg-[#0f172a] px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 border-t border-white/5 gap-2">
                            <button type="submit" class="inline-flex w-full justify-center rounded-lg bg-primary px-3 py-2 text-sm font-bold text-white shadow-sm hover:bg-primary/90 sm:w-auto transition-colors">Enviar Reseña</button>
                            <button type="button" class="mt-3 inline-flex w-full justify-center rounded-lg bg-white/5 px-3 py-2 text-sm font-semibold text-white shadow-sm ring-1 ring-inset ring-white/10 hover:bg-white/10 sm:mt-0 sm:w-auto transition-colors" onclick="closeReviewModal()">Cancelar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Data Containers -->
    <div th:each="reserva : ${reservas}" th:id="'data-' + ${reserva.id}" class="hidden">
        <div class="grid grid-cols-2 gap-4">
            <div class="col-span-2 p-3 rounded-lg bg-white/5 border border-white/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Habitación</p>
                <p class="text-lg font-bold text-white" th:text="${reserva.habitacion.numero + ' - ' + reserva.habitacion.tipo}"></p>
                <p class="text-sm text-gray-400" th:text="'Precio por noche: $' + ${reserva.habitacion.precioPorNoche}"></p>
            </div>
            
            <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Check-in</p>
                <p class="font-bold text-white" th:text="${#temporals.format(reserva.fechaInicio, 'dd/MM/yyyy')}"></p>
                <p class="text-xs text-gray-400" th:text="${reserva.horaEntrada}"></p>
            </div>
            
            <div class="p-3 rounded-lg bg-white/5 border border-white/10">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Check-out</p>
                <p class="font-bold text-white" th:text="${#temporals.format(reserva.fechaFin, 'dd/MM/yyyy')}"></p>
                <p class="text-xs text-gray-400" th:text="${reserva.horaSalida}"></p>
            </div>
            
            <div class="col-span-2 p-3 rounded-lg bg-white/5 border border-white/10 flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-400 uppercase tracking-wider">Total Pagado</p>
                    <p class="text-xl font-black text-primary" th:text="'$' + ${#numbers.formatDecimal(reserva.calcularTotalConDescuento(), 1, 2)}"></p>
                </div>
                <div class="flex gap-2">
                    <a th:href="@{/reservas/factura/{id}(id=${reserva.id})}" target="_blank" class="px-3 py-1 rounded-lg bg-white/10 hover:bg-white/20 text-white text-xs font-bold transition-colors flex items-center gap-1">
                        <span class="material-symbols-outlined text-[16px]">receipt_long</span>
                        Factura
                    </a>
                    <span class="px-3 py-1 rounded-full text-xs font-bold border flex items-center"
                          th:classappend="${reserva.estadoReserva == 'ACTIVA' ? 'bg-green-500/10 text-green-400 border-green-500/20' : (reserva.estadoReserva == 'FINALIZADA' ? 'bg-blue-500/10 text-blue-400 border-blue-500/20' : (reserva.estadoReserva == 'CANCELADA' ? 'bg-red-500/10 text-red-400 border-red-500/20' : 'bg-yellow-500/10 text-yellow-400 border-yellow-500/20'))}"
                          th:text="${reserva.estadoReserva}">
                    </span>
                </div>
            </div>
        </div>
    </div>

    <script>
        function openDetailsModal(id) {
            const content = document.getElementById('data-' + id).innerHTML;
            document.getElementById('modalContent').innerHTML = content;
            document.getElementById('detailsModal').classList.remove('hidden');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
        }

        function openReviewModal(id) {
            document.getElementById('reviewReservaId').value = id;
            document.getElementById('reviewModal').classList.remove('hidden');
            setRating(5); // Reset to 5 stars
        }

        function closeReviewModal() {
            document.getElementById('reviewModal').classList.add('hidden');
        }

        function setRating(rating) {
            document.getElementById('ratingInput').value = rating;
            const stars = document.querySelectorAll('.star-rating');
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.textContent = 'star';
                    star.parentElement.classList.add('text-yellow-400');
                    star.parentElement.classList.remove('text-gray-600');
                } else {
                    star.textContent = 'star_border';
                    star.parentElement.classList.remove('text-yellow-400');
                    star.parentElement.classList.add('text-gray-600');
                }
            });
        }
    </script>
  </div>
</div>
</body>
</html>
