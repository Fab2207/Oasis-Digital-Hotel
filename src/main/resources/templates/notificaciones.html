<!DOCTYPE html>
<html class="dark" lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/common :: head"></head>
  <body
    class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 overflow-hidden"
  >
    <div class="flex h-screen w-full overflow-hidden">
      <!-- SideNavBar -->
      <aside th:replace="fragments/common :: sidebar"></aside>

      <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <!-- Background Elements -->
        <div
          class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none"
        >
          <div
            class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] rounded-full bg-primary/5 blur-[100px]"
          ></div>
          <div
            class="absolute bottom-[-10%] left-[-5%] w-[500px] h-[500px] rounded-full bg-accent/5 blur-[100px]"
          ></div>
        </div>

        <!-- Top Header -->
        <header th:replace="fragments/common :: navbar"></header>

        <main class="flex-1 overflow-y-auto p-8 scroll-smooth">
          <div class="flex flex-col w-full max-w-7xl mx-auto flex-1 gap-8">
            <div class="flex flex-wrap justify-between gap-4">
              <div class="flex flex-col gap-1">
                <h1 class="text-white text-3xl font-bold tracking-tight">
                  Centro de Notificaciones
                </h1>
                <p class="text-white/60 text-base font-medium">
                  Mantente al día con las últimas actividades y alertas del
                  sistema.
                </p>
              </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
              <!-- Left Column: Filters -->
              <aside class="lg:col-span-4 flex flex-col gap-6">
                <div
                  class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl"
                >
                  <h2
                    class="text-lg font-bold text-white flex items-center gap-2 mb-4"
                  >
                    <span class="p-2 rounded-lg bg-primary/10 text-primary">
                      <span class="material-symbols-outlined">filter_list</span>
                    </span>
                    Filtros
                  </h2>

                  <div class="flex flex-wrap gap-2 mb-6">
                    <div
                      class="flex items-center justify-center px-4 py-2 rounded-lg cursor-pointer transition-all duration-200 border"
                      th:classappend="${filtroActual == 'todas' || filtroActual == null} ? 'bg-primary text-white border-primary shadow-lg shadow-primary/20' : 'bg-white/5 border-white/5 text-white/60 hover:bg-white/10 hover:text-white'"
                      onclick="window.location.href='/notificaciones?filtro=todas'"
                    >
                      <p class="text-sm font-bold">Todas</p>
                    </div>
                    <div
                      class="flex items-center justify-center px-4 py-2 rounded-lg cursor-pointer transition-all duration-200 border bg-white/5 border-white/5 text-white/60 hover:bg-white/10 hover:text-white"
                    >
                      <p class="text-sm font-medium">Check-ins</p>
                    </div>
                    <div
                      class="flex items-center justify-center px-4 py-2 rounded-lg cursor-pointer transition-all duration-200 border bg-white/5 border-white/5 text-white/60 hover:bg-white/10 hover:text-white"
                    >
                      <p class="text-sm font-medium">Solicitudes</p>
                    </div>
                    <div
                      class="flex items-center justify-center px-4 py-2 rounded-lg cursor-pointer transition-all duration-200 border bg-white/5 border-white/5 text-white/60 hover:bg-white/10 hover:text-white"
                    >
                      <p class="text-sm font-medium">Limpieza</p>
                    </div>
                    <div
                      class="flex items-center justify-center px-4 py-2 rounded-lg cursor-pointer transition-all duration-200 border bg-white/5 border-white/5 text-white/60 hover:bg-white/10 hover:text-white"
                    >
                      <p class="text-sm font-medium">Sistema</p>
                    </div>
                    <div
                      class="flex items-center justify-center px-4 py-2 rounded-lg cursor-pointer transition-all duration-200 border"
                      th:classappend="${filtroActual == 'archivadas'} ? 'bg-primary text-white border-primary shadow-lg shadow-primary/20' : 'bg-white/5 border-white/5 text-white/60 hover:bg-white/10 hover:text-white'"
                      onclick="window.location.href='/notificaciones?filtro=archivadas'"
                    >
                      <p class="text-sm font-medium">Archivadas</p>
                    </div>
                  </div>

                  <div
                    class="p-4 rounded-xl bg-white/5 border border-white/5 mb-6"
                  >
                    <div class="flex items-center justify-between gap-4">
                      <div class="flex flex-col gap-1">
                        <p class="text-white text-sm font-bold">
                          Mostrar solo no leídas
                        </p>
                        <p class="text-white/40 text-xs">
                          Oculta las notificaciones que ya has revisado.
                        </p>
                      </div>
                      <label
                        class="relative inline-flex items-center cursor-pointer"
                      >
                        <input
                          type="checkbox"
                          th:checked="${filtroActual == 'no-leidas'}"
                          onchange="window.location.href = this.checked ? '/notificaciones?filtro=no-leidas' : '/notificaciones?filtro=todas'"
                          class="sr-only peer"
                        />
                        <div
                          class="w-11 h-6 bg-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-primary"
                        ></div>
                      </label>
                    </div>
                  </div>

                  <a
                    th:href="@{/notificaciones/marcar-todas-leidas}"
                    class="flex w-full cursor-pointer items-center justify-center gap-2 rounded-xl h-12 bg-white/10 hover:bg-white/20 border border-white/10 text-white text-sm font-bold transition-all duration-200"
                  >
                    <span class="material-symbols-outlined">done_all</span>
                    Marcar todas como leídas
                  </a>
                </div>
              </aside>

              <!-- Right Column: Notifications -->
              <main class="lg:col-span-8 flex flex-col gap-6">
                <div
                  class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl min-h-[500px]"
                >
                  <div
                    class="flex flex-wrap justify-between items-center gap-4 mb-6"
                  >
                    <h2
                      class="text-lg font-bold text-white flex items-center gap-2"
                    >
                      <span class="p-2 rounded-lg bg-primary/10 text-primary">
                        <span class="material-symbols-outlined"
                          >notifications_active</span
                        >
                      </span>
                      Notificaciones Recientes
                    </h2>
                    <div class="relative">
                      <select
                        class="appearance-none bg-black/20 border border-white/10 text-white text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 pr-8 cursor-pointer hover:bg-black/30 transition-colors"
                      >
                        <option selected="">Más recientes</option>
                        <option value="oldest">Más antiguas</option>
                      </select>
                      <span
                        class="material-symbols-outlined absolute right-2.5 top-1/2 -translate-y-1/2 text-white/60 pointer-events-none"
                        >expand_more</span
                      >
                    </div>
                  </div>

                  <div class="flex flex-col gap-3">
                    <!-- Notification Cards (Thymeleaf) -->
                    <div
                      th:each="notificacion : ${notificaciones}"
                      th:id="'notif-' + ${notificacion.id}"
                      class="group flex items-start gap-4 p-4 rounded-xl bg-white/5 border border-transparent hover:border-white/10 hover:bg-white/10 cursor-pointer transition-all duration-200 relative overflow-hidden"
                    >
                      <!-- Unread Indicator Strip -->
                      <div
                        th:if="${!notificacion.leida}"
                        class="absolute left-0 top-0 bottom-0 w-1 bg-primary"
                      ></div>

                      <div
                        class="flex size-12 items-center justify-center rounded-xl shadow-lg flex-shrink-0"
                        th:classappend="${notificacion.tipo == 'CHECKIN'} ? 'bg-[#009B77]/20 text-[#009B77] shadow-[#009B77]/10' :
                         (${notificacion.tipo == 'SOLICITUD'} ? 'bg-[#D4AF37]/20 text-[#D4AF37] shadow-[#D4AF37]/10' :
                         (${notificacion.tipo == 'LIMPIEZA'} ? 'bg-blue-500/20 text-blue-400 shadow-blue-500/10' :
                         'bg-red-500/20 text-red-400 shadow-red-500/10'))"
                      >
                        <span
                          class="material-symbols-outlined"
                          th:text="${notificacion.tipo == 'CHECKIN'} ? 'key' :
                    (${notificacion.tipo == 'SOLICITUD'} ? 'notifications_active' :
                    (${notificacion.tipo == 'LIMPIEZA'} ? 'cleaning_services' :
                    'error'))"
                          >key</span
                        >
                      </div>

                      <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                          <p
                            class="text-white font-bold text-base truncate pr-4"
                            th:text="${notificacion.titulo}"
                          >
                            Próximo Check-in: Familia Pérez
                          </p>
                          <span
                            class="text-white/40 text-xs whitespace-nowrap font-mono"
                            th:text="${notificacion.tiempoRelativo}"
                          >
                            Hace 5 min
                          </span>
                        </div>
                        <p
                          class="text-white/60 text-sm mt-1 line-clamp-2"
                          th:text="${notificacion.mensaje}"
                        >
                          Habitación 305. Se espera su llegada en 1 hora.
                        </p>
                      </div>

                      <div
                        class="flex items-center gap-2 self-center pl-2 border-l border-white/5"
                      >
                        <div
                          class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity"
                        >
                          <a
                            th:if="${!notificacion.leida}"
                            th:href="@{/notificaciones/ver/{id}(id=${notificacion.id})}"
                            class="flex items-center justify-center size-9 rounded-lg hover:bg-white/10 text-white/40 hover:text-primary transition-colors"
                            title="Marcar como leída"
                          >
                            <span class="material-symbols-outlined text-xl"
                              >check_circle</span
                            >
                          </a>
                          <a
                            th:if="${notificacion.leida and !notificacion.archivada}"
                            th:href="@{/notificaciones/archivar/{id}(id=${notificacion.id})}"
                            class="flex items-center justify-center size-9 rounded-lg hover:bg-white/10 text-white/40 hover:text-accent transition-colors"
                            title="Archivar"
                          >
                            <span class="material-symbols-outlined text-xl"
                              >archive</span
                            >
                          </a>
                          <button
                            th:data-id="${notificacion.id}"
                            th:data-titulo="${notificacion.titulo}"
                            th:data-mensaje="${notificacion.mensaje}"
                            th:data-tiempo="${notificacion.tiempoRelativo}"
                            th:data-tipo="${notificacion.tipo}"
                            th:data-leida="${notificacion.leida}"
                            onclick="openModalFromData(this)"
                            class="flex items-center justify-center size-9 rounded-lg hover:bg-white/10 text-white/40 hover:text-white transition-colors"
                            title="Ver detalle"
                          >
                            <span class="material-symbols-outlined text-xl"
                              >visibility</span
                            >
                          </button>
                        </div>
                      </div>
                    </div>

                    <div
                      th:if="${#lists.isEmpty(notificaciones)}"
                      class="flex flex-col items-center justify-center py-20 text-white/30"
                    >
                      <span
                        class="material-symbols-outlined text-6xl mb-4 opacity-50"
                        >notifications_off</span
                      >
                      <p class="text-lg font-medium">
                        No tienes notificaciones
                      </p>
                      <p class="text-sm opacity-60">Estás al día con todo</p>
                    </div>
                  </div>
                </div>
              </main>
            </div>
          </div>
        </main>
      </div>
    </div>
    <!-- Notification Modal -->
    <div id="notificationModal" class="fixed inset-0 z-[100] hidden">
      <div
        class="absolute inset-0 bg-black/80 backdrop-blur-sm transition-opacity"
        onclick="closeNotificationModal()"
      ></div>
      <div
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-6"
      >
        <div
          class="glass-panel rounded-2xl border border-white/10 shadow-2xl relative overflow-hidden transform transition-all scale-100"
        >
          <div class="absolute top-0 right-0 p-4 z-10">
            <button
              onclick="closeNotificationModal()"
              class="p-2 rounded-full hover:bg-white/10 text-white/60 hover:text-white transition-colors"
            >
              <span class="material-symbols-outlined">close</span>
            </button>
          </div>

          <div class="p-6 flex flex-col gap-6">
            <div class="flex items-center gap-4">
              <div
                id="modalIconBg"
                class="size-16 rounded-2xl flex items-center justify-center shadow-lg"
              >
                <span id="modalIcon" class="material-symbols-outlined text-3xl"
                  >notifications</span
                >
              </div>
              <div>
                <h3
                  id="modalTitle"
                  class="text-2xl font-bold text-white leading-tight"
                >
                  Título
                </h3>
                <p id="modalDate" class="text-white/40 text-sm font-mono mt-1">
                  Fecha
                </p>
              </div>
            </div>

            <div
              class="h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"
            ></div>

            <div class="prose prose-invert max-w-none">
              <p
                id="modalMessage"
                class="text-white/80 text-lg leading-relaxed"
              >
                Mensaje detallado...
              </p>
            </div>

            <div class="flex justify-end gap-3 mt-4">
              <button
                onclick="closeNotificationModal()"
                class="px-6 py-2.5 rounded-xl bg-white/10 hover:bg-white/20 text-white font-medium transition-colors"
              >
                Cerrar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script th:inline="javascript">
      function openModalFromData(button) {
        const id = button.getAttribute("data-id");
        const title = button.getAttribute("data-titulo");
        const message = button.getAttribute("data-mensaje");
        const date = button.getAttribute("data-tiempo");
        const type = button.getAttribute("data-tipo");
        const isRead = button.getAttribute("data-leida") === "true";
        openNotificationModal(id, title, message, date, type, isRead);
      }

      function openNotificationModal(id, title, message, date, type, isRead) {
        const modal = document.getElementById("notificationModal");
        const iconBg = document.getElementById("modalIconBg");
        const icon = document.getElementById("modalIcon");

        // Set content
        document.getElementById("modalTitle").textContent = title;
        document.getElementById("modalMessage").textContent = message;
        document.getElementById("modalDate").textContent = date;

        // Set styles based on type
        let bgClass = "bg-primary/20";
        let textClass = "text-primary";
        let iconName = "notifications";

        if (type === "CHECKIN") {
          bgClass = "bg-[#009B77]/20";
          textClass = "text-[#009B77]";
          iconName = "key";
        } else if (type === "SOLICITUD") {
          bgClass = "bg-[#D4AF37]/20";
          textClass = "text-[#D4AF37]";
          iconName = "notifications_active";
        } else if (type === "LIMPIEZA") {
          bgClass = "bg-blue-500/20";
          textClass = "text-blue-400";
          iconName = "cleaning_services";
        } else if (type === "ALERTA") {
          bgClass = "bg-red-500/20";
          textClass = "text-red-400";
          iconName = "error";
        }

        iconBg.className = `size-16 rounded-2xl flex items-center justify-center shadow-lg ${bgClass} ${textClass}`;
        icon.textContent = iconName;

        // Show modal
        modal.classList.remove("hidden");

        // Mark as read if not already
        if (!isRead) {
          markAsRead(id);
        }
      }

      function closeNotificationModal() {
        document.getElementById("notificationModal").classList.add("hidden");
      }

      function markAsRead(id) {
        fetch(`/notificaciones/api/marcar-leida/${id}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRF-TOKEN":
              document.querySelector('meta[name="_csrf"]')?.content || "",
          },
        })
          .then((response) => {
            if (response.ok) {
              // Update UI: remove unread strip
              const card = document.getElementById(`notif-${id}`);
              if (card) {
                const strip = card.querySelector(".absolute.left-0");
                if (strip) strip.remove();

                // Remove "Marcar como leída" button
                const checkBtn = card.querySelector(
                  'a[title="Marcar como leída"]'
                );
                if (checkBtn) checkBtn.remove();
              }

              // Update badge count (optional, simple decrement)
              const badge = document.querySelector(
                ".material-symbols-outlined + span.bg-red-500"
              );
              if (badge) {
                // Ideally fetch new count, but removing it is a safe fallback if it was the last one
                // or just leave it until refresh
              }
            }
          })
          .catch(console.error);
      }
    </script>
  </body>
</html>
