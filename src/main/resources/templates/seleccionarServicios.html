<!DOCTYPE html>
<html class="dark" lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/common :: head"></head>
  <body
    class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 overflow-hidden"
  >
    <div class="flex h-screen w-full overflow-hidden">
      <!-- SideNavBar -->
      <aside th:replace="fragments/common :: sidebar"></aside>

      <!-- Main Content -->
      <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <!-- Background Elements -->
        <div
          class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none"
        >
          <div
            class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] rounded-full bg-primary/5 blur-[100px]"
          ></div>
          <div
            class="absolute bottom-[-10%] left-[-5%] w-[500px] h-[500px] rounded-full bg-accent/5 blur-[100px]"
          ></div>
        </div>

        <!-- Top Header -->
        <header th:replace="fragments/common :: navbar"></header>

        <main class="flex-1 overflow-y-auto p-8 scroll-smooth">
          <div class="max-w-7xl mx-auto flex flex-col lg:flex-row gap-8 h-full">
            <!-- Main Content -->
            <div class="flex-1 flex flex-col gap-8">
              <!-- PageHeading -->
              <div class="flex flex-col gap-2">
                <h1 class="text-white text-4xl font-black tracking-tight">
                  Servicios Adicionales
                </h1>
                <p class="text-white/60 text-lg font-medium">
                  Personalice su estancia con nuestros servicios exclusivos.
                </p>
              </div>

              <!-- Services Grid -->
              <form
                th:action="@{/reservas/{id}/servicios(id=${reserva.id})}"
                method="post"
                id="serviciosForm"
                class="flex-1"
              >
                <input type="hidden" name="returnTo" th:value="${returnTo}" />

                <div
                  class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"
                >
                  <!-- Service Cards -->
                  <div
                    th:each="servicio : ${serviciosDisponibles}"
                    class="glass-panel rounded-2xl overflow-hidden border border-white/10 group hover:border-primary/50 transition-all duration-300 hover:shadow-xl hover:shadow-primary/10 flex flex-col"
                  >
                    <div class="relative h-48 overflow-hidden">
                      <div
                        class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent z-10 opacity-60"
                      ></div>
                      <img
                        src="https://images.unsplash.com/photo-1540555700478-4be289fbecef?w=400"
                        class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110"
                        alt="Servicio"
                      />
                      <div class="absolute bottom-4 left-4 z-20">
                        <span
                          class="px-3 py-1 rounded-full bg-black/60 backdrop-blur-md border border-white/10 text-primary text-xs font-bold uppercase tracking-wider"
                          th:text="'S/. ' + ${servicio.precio}"
                        >
                          S/. 120.00
                        </span>
                      </div>
                    </div>

                    <div class="p-5 flex flex-col flex-1 gap-4">
                      <div>
                        <h3
                          class="text-white text-xl font-bold mb-2 group-hover:text-primary transition-colors"
                          th:text="${servicio.nombre}"
                        >
                          Servicio
                        </h3>
                        <p
                          class="text-white/60 text-sm line-clamp-3"
                          th:text="${servicio.descripcion}"
                        >
                          Descripción
                        </p>
                      </div>

                      <div class="mt-auto pt-4 border-t border-white/10">
                        <label
                          class="flex items-center justify-between cursor-pointer select-none group/check"
                        >
                          <span
                            class="text-sm font-bold text-white/80 group-hover/check:text-white transition-colors"
                            >Agregar a la reserva</span
                          >
                          <div class="relative">
                            <input
                              type="checkbox"
                              name="servicioIds"
                              th:value="${servicio.id}"
                              th:checked="${serviciosSeleccionados.contains(servicio.id)}"
                              th:data-nombre="${servicio.nombre}"
                              th:data-precio="${servicio.precio}"
                              onchange="actualizarResumen()"
                              class="peer sr-only"
                            />
                            <div
                              class="w-12 h-7 bg-white/10 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-primary"
                            ></div>
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>

                  <div
                    th:if="${#lists.isEmpty(serviciosDisponibles)}"
                    class="col-span-full py-16 text-center glass-panel rounded-2xl border border-white/10 flex flex-col items-center justify-center gap-4"
                  >
                    <div
                      class="size-20 rounded-full bg-white/5 flex items-center justify-center"
                    >
                      <span
                        class="material-symbols-outlined text-4xl text-white/20"
                        >room_service</span
                      >
                    </div>
                    <p class="text-white/60 text-lg">
                      No hay servicios disponibles en este momento.
                    </p>
                  </div>
                </div>
              </form>
            </div>

            <!-- Booking Summary Panel -->
            <aside class="w-full lg:w-96 flex-shrink-0">
              <div
                class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl sticky top-6"
              >
                <h3
                  class="text-xs font-bold text-white/40 uppercase tracking-widest mb-6 flex items-center gap-2"
                >
                  <span class="material-symbols-outlined text-base text-primary"
                    >receipt_long</span
                  >
                  Resumen de Reserva
                </h3>

                <div class="flex flex-col gap-4 mb-6">
                  <!-- Room Info -->
                  <div
                    class="p-4 rounded-xl bg-white/5 border border-white/5 flex justify-between items-start"
                  >
                    <div>
                      <p
                        class="font-bold text-white text-sm"
                        th:text="${reserva.habitacion.tipo}"
                      >
                        Habitación Deluxe
                      </p>
                      <p
                        class="text-xs text-white/60 mt-1"
                        th:text="'Habitación ' + ${reserva.habitacion.numero}"
                      >
                        Hab. 101
                      </p>
                      <p
                        class="text-xs text-white/60"
                        th:text="${reserva.diasEstadia + ' noches'}"
                      >
                        2 noches
                      </p>
                    </div>
                    <p
                      class="font-bold text-primary"
                      th:text="'S/. ' + ${#numbers.formatDecimal(reserva.totalPagar, 1, 2)}"
                    >
                      S/. 540.00
                    </p>
                  </div>

                  <!-- Selected Services List -->
                  <div class="space-y-2">
                    <p
                      class="text-xs font-bold text-white/40 uppercase tracking-wider ml-1"
                    >
                      Servicios Seleccionados
                    </p>
                    <div
                      id="serviciosSeleccionadosList"
                      class="flex flex-col gap-2 min-h-[50px]"
                    >
                      <!-- JS Injected -->
                    </div>
                  </div>
                </div>

                <div class="border-t border-white/10 pt-6 flex flex-col gap-3">
                  <div class="flex justify-between text-white/60 text-sm">
                    <span>Subtotal Habitación</span>
                    <span
                      th:text="'S/. ' + ${#numbers.formatDecimal(reserva.totalPagar, 1, 2)}"
                      >S/. 540.00</span
                    >
                  </div>
                  <div class="flex justify-between text-white/60 text-sm">
                    <span>Subtotal Servicios</span>
                    <span id="subtotalServicios" class="text-white"
                      >S/. 0.00</span
                    >
                  </div>
                  <div
                    class="flex justify-between text-white/60 text-sm"
                    th:if="${reserva.montoDescuento != null && reserva.montoDescuento > 0}"
                  >
                    <span>Descuento Aplicado</span>
                    <span
                      class="text-green-400 font-bold"
                      th:text="'- S/. ' + ${#numbers.formatDecimal(reserva.montoDescuento, 1, 2)}"
                      >- S/. 20.00</span
                    >
                  </div>
                  <div
                    class="flex justify-between items-end mt-2 pt-4 border-t border-white/10"
                  >
                    <span class="text-white font-bold">Total Estimado</span>
                    <span
                      id="totalFinal"
                      class="text-3xl font-black text-primary"
                      th:text="'S/. ' + ${#numbers.formatDecimal(reserva.totalPagar, 1, 2)}"
                    >
                      S/. 615.00
                    </span>
                  </div>
                </div>

                <div class="mt-8 flex flex-col gap-3">
                  <button
                    type="submit"
                    form="serviciosForm"
                    class="w-full py-4 bg-primary text-white font-bold rounded-xl hover:bg-primary/90 transition-all duration-200 shadow-lg shadow-primary/20 hover:scale-[1.02] flex items-center justify-center gap-2"
                  >
                    <span>Continuar al Pago</span>
                    <span class="material-symbols-outlined text-lg"
                      >arrow_forward</span
                    >
                  </button>
                  </button>
                  
                  <form th:action="@{/reservas/{id}/cancelar-proceso(id=${reserva.id})}" method="post" class="w-full">
                      <button
                        type="submit"
                        class="w-full py-3 text-white/60 hover:text-red-400 font-medium text-center transition-colors text-sm flex items-center justify-center gap-2"
                        onclick="return confirm('¿Estás seguro de cancelar el proceso? La reserva se eliminará.')"
                      >
                        <span class="material-symbols-outlined text-lg">cancel</span>
                        Cancelar Reserva
                      </button>
                  </form>
                </div>
              </div>
            </aside>
          </div>
        </main>
      </div>
    </div>

    <script th:inline="javascript">
      // Datos de la reserva desde Thymeleaf
      const montoBase = /*[[${reserva.totalPagar}]]*/ 540;
      const montoDescuento = /*[[${reserva.montoDescuento ?: 0}]]*/ 0;

      function actualizarResumen() {
        const checkboxes = document.querySelectorAll(
          'input[name="servicioIds"]:checked'
        );
        const listaDiv = document.getElementById("serviciosSeleccionadosList");
        const subtotalSpan = document.getElementById("subtotalServicios");
        const totalSpan = document.getElementById("totalFinal");

        listaDiv.innerHTML = "";
        let totalServicios = 0;

        if (checkboxes.length === 0) {
          listaDiv.innerHTML =
            '<div class="p-3 rounded-lg border border-dashed border-white/10 text-center"><p class="text-xs text-white/40 italic">Ningún servicio seleccionado</p></div>';
        }

        checkboxes.forEach((checkbox) => {
          const nombre = checkbox.getAttribute("data-nombre");
          const precio = parseFloat(checkbox.getAttribute("data-precio"));
          totalServicios += precio;

          const itemDiv = document.createElement("div");
          itemDiv.className =
            "flex justify-between items-center text-sm p-3 rounded-lg bg-white/5 border border-white/5 animate-fade-in";
          itemDiv.innerHTML = `
            <span class="text-white/80 font-medium">${nombre}</span>
            <span class="text-white font-bold">S/. ${precio.toFixed(2)}</span>
          `;
          listaDiv.appendChild(itemDiv);
        });

        subtotalSpan.textContent = "S/. " + totalServicios.toFixed(2);

        // Calcular total final restando el descuento
        const totalCalculado = Math.max(
          0,
          montoBase + totalServicios - montoDescuento
        );

        totalSpan.textContent = "S/. " + totalCalculado.toFixed(2);
      }

      // Actualizar al cargar la página
      document.addEventListener("DOMContentLoaded", actualizarResumen);
    </script>

    <style>
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(5px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .animate-fade-in {
        animation: fadeIn 0.3s ease-out forwards;
      }
    </style>
  </body>
</html>
