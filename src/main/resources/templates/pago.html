<!DOCTYPE html>
<html class="dark" lang="es" xmlns:th="http://www.thymeleaf.org">
  <head th:replace="fragments/common :: head"></head>
  <body
    class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100 overflow-hidden"
  >
    <script
      defer=""
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>

    <div
      class="flex h-screen w-full overflow-hidden"
      x-data="{ paymentMethod: 'card' }"
    >
      <!-- SideNavBar -->
      <aside th:replace="fragments/common :: sidebar"></aside>

      <div class="flex-1 flex flex-col min-w-0 overflow-hidden relative">
        <!-- Background Elements -->
        <div
          class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10 pointer-events-none"
        >
          <div
            class="absolute top-[-10%] right-[-5%] w-[500px] h-[500px] rounded-full bg-primary/5 blur-[100px]"
          ></div>
          <div
            class="absolute bottom-[-10%] left-[-5%] w-[500px] h-[500px] rounded-full bg-accent/5 blur-[100px]"
          ></div>
        </div>

        <!-- Top Header -->
        <header th:replace="fragments/common :: navbar"></header>

        <main class="flex-1 overflow-y-auto p-4 lg:p-8 scroll-smooth">
          <div class="max-w-5xl mx-auto flex flex-col gap-6">
            <!-- Breadcrumbs -->
            <div class="flex items-center gap-2 text-sm text-white/60">
              <span class="text-primary font-bold">Reserva</span>
              <span class="material-symbols-outlined text-xs"
                >chevron_right</span
              >
              <span class="text-primary font-bold">Servicios</span>
              <span class="material-symbols-outlined text-xs"
                >chevron_right</span
              >
              <span class="text-white font-bold">Pago</span>
            </div>

            <div class="flex flex-col gap-2">
              <h1 class="text-white text-3xl font-black tracking-tight">
                Proceso de Pago
              </h1>
              <p class="text-white/60 text-base font-medium">
                Complete su reserva de forma segura.
              </p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
              <!-- Payment Form -->
              <div class="lg:col-span-2 flex flex-col gap-6">
                <form
                  th:action="@{/reservas/{id}/pago(id=${reserva.id})}"
                  method="post"
                  class="flex flex-col gap-6"
                >
                  <input type="hidden" name="returnTo" th:value="${returnTo}" />

                  <!-- Method Selection -->
                  <div
                    class="glass-panel rounded-2xl p-8 border border-white/10 shadow-xl"
                  >
                    <h2
                      class="text-xl font-bold text-white mb-6 flex items-center gap-2"
                    >
                      <span class="p-2 rounded-lg bg-primary/10 text-primary">
                        <span class="material-symbols-outlined"
                          >credit_card</span
                        >
                      </span>
                      Método de Pago
                    </h2>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                      <button
                        type="button"
                        :class="{ 'border-primary bg-primary/10 ring-1 ring-primary shadow-lg shadow-primary/10': paymentMethod === 'card', 'border-white/10 bg-white/5 hover:bg-white/10 hover:border-white/20': paymentMethod !== 'card' }"
                        @click="paymentMethod = 'card'"
                        class="flex items-center gap-3 p-4 rounded-xl border transition-all duration-200"
                      >
                        <div class="flex items-center gap-2">
                          <span
                            class="material-symbols-outlined text-2xl"
                            :class="paymentMethod === 'card' ? 'text-primary' : 'text-white/60'"
                            >credit_card</span
                          >
                        </div>
                        <span
                          class="font-bold"
                          :class="paymentMethod === 'card' ? 'text-primary' : 'text-white/80'"
                          >Tarjeta</span
                        >
                      </button>
                      <button
                        type="button"
                        :class="{ 'border-primary bg-primary/10 ring-1 ring-primary shadow-lg shadow-primary/10': paymentMethod === 'wallet', 'border-white/10 bg-white/5 hover:bg-white/10 hover:border-white/20': paymentMethod !== 'wallet' }"
                        @click="paymentMethod = 'wallet'"
                        class="flex items-center gap-3 p-4 rounded-xl border transition-all duration-200"
                      >
                        <div class="flex items-center gap-2">
                          <span
                            class="material-symbols-outlined text-2xl"
                            :class="paymentMethod === 'wallet' ? 'text-primary' : 'text-white/60'"
                            >account_balance_wallet</span
                          >
                        </div>
                        <span
                          class="font-bold"
                          :class="paymentMethod === 'wallet' ? 'text-primary' : 'text-white/80'"
                          >Billetera Digital</span
                        >
                      </button>
                    </div>

                    <input
                      type="hidden"
                      name="metodo"
                      x-model="paymentMethod === 'card' ? 'TARJETA' : 'WALLET'"
                    />

                    <!-- Card Fields -->
                    <div
                      class="flex flex-col gap-4"
                      x-show="paymentMethod === 'card'"
                      x-transition:enter="transition ease-out duration-300"
                      x-transition:enter-start="opacity-0 -translate-y-2"
                      x-transition:enter-end="opacity-100 translate-y-0"
                    >
                      <div class="space-y-1.5">
                        <label
                          class="text-xs font-bold text-white/60 uppercase tracking-wider ml-1"
                          >Titular de la tarjeta</label
                        >
                        <div class="relative">
                          <span
                            class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/40 pointer-events-none"
                          >
                            <span class="material-symbols-outlined text-lg"
                              >person</span
                            >
                          </span>
                          <input
                            class="w-full pl-10 pr-4 py-3 rounded-xl bg-black/20 border border-white/10 text-white placeholder:text-white/20 focus:ring-2 focus:ring-primary/50 focus:border-primary/50 focus:bg-black/40 transition-all duration-300"
                            id="card-holder"
                            name="titularTarjeta"
                            placeholder="Como aparece en la tarjeta"
                            type="text"
                          />
                        </div>
                      </div>
                      <div class="space-y-1.5">
                        <label
                          class="text-xs font-bold text-white/60 uppercase tracking-wider ml-1"
                          >Número de tarjeta</label
                        >
                        <div class="relative">
                          <span
                            class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/40 pointer-events-none"
                          >
                            <span class="material-symbols-outlined text-lg"
                              >credit_card</span
                            >
                          </span>
                          <input
                            class="w-full pl-10 pr-4 py-3 rounded-xl bg-black/20 border border-white/10 text-white placeholder:text-white/20 focus:ring-2 focus:ring-primary/50 focus:border-primary/50 focus:bg-black/40 transition-all duration-300"
                            id="card-number"
                            name="numeroTarjeta"
                            placeholder="0000 0000 0000 0000"
                            type="text"
                            maxlength="19"
                          />
                        </div>
                      </div>
                      <div class="grid grid-cols-2 gap-4">
                        <div class="space-y-1.5">
                          <label
                            class="text-xs font-bold text-white/60 uppercase tracking-wider ml-1"
                            >Vencimiento</label
                          >
                          <div class="relative">
                            <span
                              class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/40 pointer-events-none"
                            >
                              <span class="material-symbols-outlined text-lg"
                                >calendar_month</span
                              >
                            </span>
                            <input
                              class="w-full pl-10 pr-4 py-3 rounded-xl bg-black/20 border border-white/10 text-white placeholder:text-white/20 focus:ring-2 focus:ring-primary/50 focus:border-primary/50 focus:bg-black/40 transition-all duration-300"
                              id="expiry-date"
                              name="fechaExp"
                              placeholder="MM/AA"
                              type="text"
                              maxlength="5"
                            />
                          </div>
                        </div>
                        <div class="space-y-1.5">
                          <label
                            class="text-xs font-bold text-white/60 uppercase tracking-wider ml-1"
                            >CVV</label
                          >
                          <div class="relative">
                            <span
                              class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/40 pointer-events-none"
                            >
                              <span class="material-symbols-outlined text-lg"
                                >lock</span
                              >
                            </span>
                            <input
                              class="w-full pl-10 pr-4 py-3 rounded-xl bg-black/20 border border-white/10 text-white placeholder:text-white/20 focus:ring-2 focus:ring-primary/50 focus:border-primary/50 focus:bg-black/40 transition-all duration-300"
                              id="cvv"
                              name="cvv"
                              placeholder="123"
                              type="text"
                              maxlength="4"
                            />
                          </div>
                        </div>
                      </div>
                    </div>

                    <!-- Wallet Fields -->
                    <div
                      class="flex flex-col gap-4"
                      x-cloak
                      x-show="paymentMethod === 'wallet'"
                      x-transition:enter="transition ease-out duration-300"
                      x-transition:enter-start="opacity-0 -translate-y-2"
                      x-transition:enter-end="opacity-100 translate-y-0"
                    >
                      <div class="space-y-1.5">
                        <label
                          class="text-xs font-bold text-white/60 uppercase tracking-wider ml-1"
                          >Número de Celular (Yape/Plin)</label
                        >
                        <div class="relative">
                          <span
                            class="absolute inset-y-0 left-0 flex items-center pl-3 text-white/40 pointer-events-none"
                          >
                            <span class="material-symbols-outlined text-lg"
                              >smartphone</span
                            >
                          </span>
                          <input
                            class="w-full pl-10 pr-4 py-3 rounded-xl bg-black/20 border border-white/10 text-white placeholder:text-white/20 focus:ring-2 focus:ring-primary/50 focus:border-primary/50 focus:bg-black/40 transition-all duration-300"
                            id="phone-number"
                            name="telefonoWallet"
                            placeholder="987 654 321"
                            type="tel"
                            maxlength="9"
                          />
                        </div>
                      </div>
                      <div
                        class="p-4 bg-primary/10 rounded-xl border border-primary/20 flex gap-3 items-start"
                      >
                        <span class="material-symbols-outlined text-primary"
                          >info</span
                        >
                        <p class="text-sm text-white/80">
                          Recibirá una solicitud de cobro en su billetera
                          digital. Asegúrese de tener la aplicación instalada y
                          activa.
                        </p>
                      </div>
                    </div>
                  </div>

                  <!-- Terms and Submit -->
                  <div
                    class="glass-panel rounded-2xl p-8 border border-white/10 shadow-xl flex flex-col gap-6"
                  >
                    <label class="flex items-start gap-3 cursor-pointer group">
                      <div class="relative flex items-center">
                        <input
                          type="checkbox"
                          class="peer h-5 w-5 cursor-pointer appearance-none rounded-md border border-white/30 bg-white/5 transition-all checked:border-primary checked:bg-primary hover:border-white/50 focus:ring-2 focus:ring-primary/50 focus:ring-offset-0 focus:ring-offset-transparent"
                          required
                        />
                        <span
                          class="pointer-events-none absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-white opacity-0 transition-opacity peer-checked:opacity-100"
                        >
                          <svg
                            xmlns="http://www.w3.org/2000/svg"
                            class="h-3.5 w-3.5"
                            viewBox="0 0 20 20"
                            fill="currentColor"
                          >
                            <path
                              fill-rule="evenodd"
                              d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                              clip-rule="evenodd"
                            />
                          </svg>
                        </span>
                      </div>
                      <span
                        class="text-sm text-white/70 group-hover:text-white transition-colors select-none"
                      >
                        He leído y acepto los
                        <a
                          href="#"
                          class="text-primary hover:underline font-bold"
                          >Términos y Condiciones</a
                        >
                        y la
                        <a
                          href="#"
                          class="text-primary hover:underline font-bold"
                          >Política de Privacidad</a
                        >.
                      </span>
                    </label>

                    <button
                      type="submit"
                      class="w-full py-4 bg-primary hover:bg-primary/90 text-white font-bold rounded-xl transition-all duration-200 shadow-lg shadow-primary/20 hover:scale-[1.02] flex items-center justify-center gap-2"
                    >
                      <span class="material-symbols-outlined">lock</span>
                      Confirmar Pago
                    </button>

                    <div
                      class="flex justify-center items-center gap-2 text-xs text-white/40 font-medium uppercase tracking-wider"
                    >
                      <span class="material-symbols-outlined text-base"
                        >verified_user</span
                      >
                      Transacción segura encriptada con SSL
                    </div>
                  </div>
                </form>
              </div>

              <!-- Summary Sidebar -->
              <div class="lg:col-span-1">
                <div
                  class="glass-panel rounded-2xl p-6 border border-white/10 shadow-xl sticky top-6 flex flex-col gap-6"
                >
                  <h3
                    class="text-xl font-bold text-white flex items-center gap-2"
                  >
                    <span class="p-2 rounded-lg bg-accent/10 text-accent">
                      <span class="material-symbols-outlined"
                        >receipt_long</span
                      >
                    </span>
                    Resumen
                  </h3>

                  <div
                    class="flex items-center gap-4 pb-6 border-b border-white/10"
                  >
                    <div
                      class="size-16 rounded-xl bg-gray-800 bg-cover bg-center shadow-lg"
                      style="
                        background-image: url('https://images.unsplash.com/photo-1590490360182-c33d57733427?w=100');
                      "
                    ></div>
                    <div>
                      <p
                        class="font-bold text-white text-lg"
                        th:text="${reserva.habitacion.numero + ' - ' + reserva.habitacion.tipo}"
                      >
                        Suite Junior
                      </p>
                      <p
                        class="text-sm text-white/60 font-medium"
                        th:text="${#temporals.format(reserva.fechaInicio, 'dd MMM') + ' - ' + #temporals.format(reserva.fechaFin, 'dd MMM, yyyy')}"
                      >
                        Fechas
                      </p>
                    </div>
                  </div>

                  <div class="flex flex-col gap-3 text-sm">
                    <div class="flex justify-between text-white/70">
                      <span
                        th:text="'Estancia (' + ${reserva.diasEstadia} + ' noches)'"
                        >Estancia</span
                      >
                      <span
                        class="font-mono text-white"
                        th:text="'S/. ' + ${#numbers.formatDecimal(montoBase, 1, 2)}"
                        >S/. 0.00</span
                      >
                    </div>
                    <div
                      th:each="servicio : ${reserva.servicios}"
                      class="flex justify-between text-white/70"
                    >
                      <span th:text="${servicio.nombre}">Servicio</span>
                      <span
                        class="font-mono text-white"
                        th:text="'S/. ' + ${#numbers.formatDecimal(servicio.precio, 1, 2)}"
                        >S/. 0.00</span
                      >
                    </div>
                  </div>

                  <div
                    class="pt-4 border-t border-white/10 flex flex-col gap-4"
                  >
                    <!-- Discount Section -->
                    <div
                      th:if="${reserva.descuento != null}"
                      class="flex justify-between items-center text-green-400 bg-green-500/10 p-3 rounded-lg border border-green-500/20"
                    >
                      <div class="flex flex-col">
                        <span class="text-xs font-bold uppercase"
                          >Descuento Aplicado</span
                        >
                        <span
                          class="text-sm"
                          th:text="${reserva.descuento.codigo}"
                          >CODE</span
                        >
                      </div>
                      <div class="flex items-center gap-2">
                        <span
                          class="font-mono font-bold"
                          th:text="'- S/. ' + ${#numbers.formatDecimal(reserva.montoDescuento, 1, 2)}"
                        ></span>
                        <form
                          th:action="@{/reservas/{id}/quitar-descuento(id=${reserva.id})}"
                          method="post"
                        >
                          <input
                            type="hidden"
                            name="returnTo"
                            th:value="${returnTo}"
                          />
                          <button
                            type="submit"
                            class="text-red-400 hover:text-red-300 transition-colors"
                            title="Quitar cupón"
                          >
                            <span class="material-symbols-outlined text-lg"
                              >close</span
                            >
                          </button>
                        </form>
                      </div>
                    </div>

                    <div
                      th:if="${reserva.descuento == null}"
                      class="flex flex-col gap-2"
                    >
                      <form
                        th:action="@{/reservas/{id}/aplicar-descuento(id=${reserva.id})}"
                        method="post"
                        class="flex gap-2"
                      >
                        <input
                          type="hidden"
                          name="returnTo"
                          th:value="${returnTo}"
                        />
                        <input
                          type="text"
                          name="codigo"
                          placeholder="Código de cupón"
                          class="flex-1 px-3 py-2 rounded-lg bg-black/20 border border-white/10 text-white text-sm placeholder:text-white/20 focus:ring-1 focus:ring-primary/50 focus:border-primary/50"
                          required
                        />
                        <button
                          type="submit"
                          class="px-3 py-2 bg-white/10 hover:bg-white/20 text-white rounded-lg transition-colors"
                        >
                          <span class="material-symbols-outlined text-lg"
                            >check</span
                          >
                        </button>
                      </form>
                    </div>
                  </div>

                  <div class="pt-4 border-t border-white/10">
                    <div class="flex justify-between items-end">
                      <span class="text-white font-bold text-lg"
                        >Total a Pagar</span
                      >
                      <span
                        class="text-3xl font-black text-primary"
                        th:text="'S/. ' + ${#numbers.formatDecimal(montoTotal, 1, 2)}"
                        >S/. 0.00</span
                      >
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Input Formatting
        const cardInput = document.getElementById("card-number");
        if (cardInput) {
          cardInput.addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            value = value.substring(0, 16);
            let formattedValue = value.match(/.{1,4}/g)?.join(" ") || value;
            e.target.value = formattedValue;
          });
        }

        const expiryInput = document.getElementById("expiry-date");
        if (expiryInput) {
          expiryInput.addEventListener("input", function (e) {
            let value = e.target.value.replace(/\D/g, "");
            if (value.length > 2) {
              value = value.substring(0, 2) + "/" + value.substring(2, 4);
            }
            e.target.value = value;
          });
        }

        // Form Validation
        const form = document.querySelector('form[action*="/pago"]');
        if (form) {
          form.addEventListener("submit", function (e) {
            const metodoInput = form.querySelector('input[name="metodo"]');
            // The hidden input value is updated by Alpine, but it might happen slightly after click if not bound directly.
            // However, since it's x-model, it should be sync.
            // Let's rely on the Alpine component state if possible, or just read the input which should be updated.
            // Wait, x-model on a hidden input might not work as expected in all Alpine versions if it's not a standard input.
            // But let's assume the value is correct or check the visible elements.

            // Better approach: check which container is visible
            const cardContainer = document.querySelector(
              "[x-show=\"paymentMethod === 'card'\"]"
            );
            const isCardVisible =
              cardContainer &&
              window.getComputedStyle(cardContainer).display !== "none";

            let isValid = true;
            let errorMessage = "";

            if (isCardVisible) {
              const holder = document
                .getElementById("card-holder")
                .value.trim();
              const number = document
                .getElementById("card-number")
                .value.trim();
              const expiry = document
                .getElementById("expiry-date")
                .value.trim();
              const cvv = document.getElementById("cvv").value.trim();

              if (!holder || !number || !expiry || !cvv) {
                isValid = false;
                errorMessage =
                  "Por favor, complete todos los datos de la tarjeta.";
              } else if (number.replace(/\s/g, "").length < 16) {
                isValid = false;
                errorMessage = "El número de tarjeta debe tener 16 dígitos.";
              }
            } else {
              // Wallet
              const phone = document
                .getElementById("phone-number")
                .value.trim();
              if (!phone) {
                isValid = false;
                errorMessage =
                  "Por favor, ingrese el número de celular asociado a la billetera.";
              }
            }

            if (!isValid) {
              e.preventDefault();
              alert(errorMessage);
            }
          });
        }
      });
    </script>
    <style>
      [x-cloak] {
        display: none !important;
      }
    </style>
  </body>
</html>
